---
title: Браузеры
description: Как работают браузеры?
---

### 1. Навигация

Навигация - это первый шаг загрузки веб-страницы. Она происходит когда пользователь вводит URL в адресной строке или делает клик по ссылке.

<Mermaid
  chart="
flowchart TD
  A[Пользователь] -->|Вводит URL| B[Браузер]
  B --> C[DNS-поиск]
  C --> D[TCP-рукопожатие]
  D --> E[TLS-рукопожатие]
  E --> F[HTTP-запрос]
"
/>

#### DNS-поиск

Первый шаг - найти IP-адрес, где располагаются ресурсы. Это делается с помощью DNS-поиска.

> DNS (Domain Name System)-сервер - это сервер, который главным образом используются для сопоставления имени хоста веб-сайта (пр.: [www.example.com](http://www.example.com)) с соответствующим ему IP-адресом. Он содержит базу данных публичных IP-адресов и им соответствующих доменных имен.

Например если вы посетите страницу [www.example.com](http://www.example.com), то DNS-сервер вернет вам ее IP-адрес (93.184.216.34).

#### Тройное TCP-рукопожатие

Следующий шаг - установить с сервером TCP-соединение. Это делается благодаря тройному TCP-рукопожатию.

> **Примечание переводчика.** Transmission Control Protocol (TCP) - протокол управления передачей. Это стандарт, определяющий порядок установления и поддержания сетевого взаимодействия, с помощью которого приложения могут обмениваться данными.

<Mermaid
  chart="
sequenceDiagram
  participant Client as Клиент
  participant Server as Сервер
  Client->>Server: SYN
  Server->>Client: SYN-ACK
  Client->>Server: ACK
"
/>

#### TLS-рукопожатие

Если веб-сайт использует протокол HTTPS (аббр. от англ. Hypertext Transfer Protocol Secure - защищенный протокол передачи гипертекста), то следующий шаг - установить TLS-соединение через TLS-рукопожатие.

<Callout>
**Примечание переводчика.** TLS (аббр. от англ. Transport Layer Security - защита транспортного уровня) - шифрует данные, передаваемые через Интернет, чтобы подслушивающие устройства и хакеры не могли увидеть то, что вы передаете, что особенно полезно для частной и конфиденциальной информации, такой как пароли, номера кредитных карт и личная переписка.
</Callout>

<Mermaid
  chart="
sequenceDiagram
  participant Client as Браузер
  participant Server as Сервер
  Client->>Server: Client Hello (версия TLS, шифры, client random)
  Server->>Client: Server Hello (сертификат, шифры, server random)
  Client->>Server: Проверка сертификата
  Client->>Server: Premaster secret (зашифрованный)
  Server->>Client: Подтверждение
  Client->>Server: Session keys
  Server->>Client: Session keys
  Note right of Client: Безопасное соединение установлено
"
/>

### 2. Фетчинг ресурсов

После того как установлено TCP-соединение браузер может начать фетчинг (от англ. гл. to fetch - получать, загружать) ресурсов сервера.

<Mermaid
  chart="
flowchart LR
  A[Браузер] -->|HTTP GET запрос| B[Сервер]
  B -->|HTTP ответ| A
  A --> C[HTML]
  A --> D[CSS]
  A --> E[JavaScript]
  A --> F[Изображения]
"
/>

#### HTTP-запрос

Если у вас уже есть опыт в веб-разработке, то вы наверняка встречали понятие HTTP-запросов.

HTTP-запросы используются для фетчинга ресурсов сервера. Для запросов необходимо указать URL и тип запроса (GET, POST, PUT, DELETE). Браузер также добавляет заголовки (headers) к запросу, что бы предоставить дополнительную информацию.

Первый запрос к серверу обычно является GET-запросом на получение HTML-файла.

#### HTTP-ответ

Затем сервер отвечает соответствующим HTTP-ответом. Ответ содержит код состояния (status code), заголовки (headers) и тело ответа (body).

### 3. Парсинг HTML

Теперь начинается главная секция. После того как браузер получил HTML-файл он парсит (от англ. гл. to parse - разбирать, анализировать) его для создания DOM (Document Object Model)-дерева.

Это делается при помощи движка браузера, который является его ядром (Пр.: Gecko для Firefox, Webkit для Safari, Blink для Chrome и т.д.).

Вот пример HTML-файла:

```html
<!DOCTYPE html>
<html>
  <head>
    <title>Page Title</title>
  </head>
  <body>
    <p>Hello World!</p>
  </body>
</html>
```

#### Токенизация

Первый шаг на пути к отображению веб-страницы - это токенизация HTML-файла. **Токенизация** - это процесс деления строки символов на значимые чанки (от англ. chunk - кусок) для браузера, именуемые токенами (от англ. token - жетон).

Токены являются базовыми строительными блоками DOM-дерева.

<Mermaid
  chart="
flowchart LR
  A[HTML] --> B[Токенизатор]
  B --> C[Токены]
  C --> D[DOM-дерево]
"
/>

#### Строительство DOM-дерева

**Лексинг** (lexing) - это процесс конвертации токенов в древовидную структуру именуемую DOM-деревом.

**DOM-дерево** - это древовидная структура данных, которая представляет собой ноды(от англ. node - узел) в HTML-документе.

<Mermaid
  chart="
graph TD
  html[html] --> head[head]
  html --> body[body]
  head --> title[title: Page Title]
  body --> p[p: Hello World!]
"
/>

### 4. Парсинг CSS

После того как DOM-дерево построено, браузер парсит CSS-файлы для создания CSSOM (CSS Object Model).

Этот процесс аналогичен построению DOM-дерева с использованием токенизации и генерации CSSOM.

### 5. Выполнение JavaScript

Как упоминалось ранее, если у страницы есть блокирующий скрипт, то он будет загружен и обработан незамедлительно, в то время как строительство DOM-дерева будет отложено, либо же скрипт будет загружен и выполнен после того, как DOM-дерево будет полностью создано.

Независимо от того когда выполняется скрипт, он будет обработан движком JavaScript, который похож на движок браузера и зависит от того какой браузер используется.

#### JIT-компиляция

<Mermaid
  chart="
flowchart TB
  subgraph JIT[Just-In-Time Компиляция]
    A[Исходный код] --> B[Байт-код]
    B --> C[Оптимизированный машинный код]
    C --> D[Выполнение]
  end
"
/>

### 6. Рендеринг

Наконец-то пришло время рендера (от англ. rendering - визуализация) страницы. Для рендеринга браузер использует DOM-дерево и CSSOM.

<Mermaid
  chart="
flowchart TB
  DOM[DOM-дерево] --> RenderTree[Дерево рендера]
  CSSOM[CSSOM] --> RenderTree
  RenderTree --> Layout[Компоновка]
  Layout --> Paint[Отрисовка]
  Paint --> Composite[Композиция]
"
/>

#### Построение дерева рендера

Первый шаг - построить дерево рендера. Дерево рендера - это подмножество DOM-дерева, состоящее только из видимых на странице элементов.

#### Компоновка (layout)

Следующим этапом является компоновка дерева рендера. Она делается путем расчетов точных размеров и позиции каждого элемента в дереве рендера.

Этот этап происходит каждый раз, когда мы изменяем что-нибудь в DOM, что затрагивает компоновку страницы, даже частично.

Примеры ситуаций, когда позиция элементов перерассчитывается:

1. Добавление или удаление элементов из DOM
2. Изменение размеров окна браузера
3. Изменение ширины, высоты или позиции элемента

#### Отрисовка (painting)

Наконец, браузер решает, какие ноды должны быть видимыми, и рассчитывает их позицию в области просмотра (viewport), после чего наступает время их отрисовать (сделать рендер пикселей) на экране.

#### Наложение слоев и композиция

<Mermaid
  chart="
flowchart LR
  A[Слой 1] --> B[Композитор]
  C[Слой 2] --> B
  D[Слой 3] --> B
  B --> E[Финальное изображение]
"
/>

Финальный этап - композиция слоев. Это делается браузером для оптимизации процесса рендеринга.

<Callout>
**Композиция** _(compositing)_ - это техника разделения частей страницы на слои, их отрисовки и дальнейшего составления из них страницы в отдельном потоке называемом композиторским потоком (compositor thread).
</Callout>
